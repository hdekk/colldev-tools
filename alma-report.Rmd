---
title: "R Notebook"
output: html_notebook
---

Use readxl to read spreadsheet data.

```{r}
library(readxl)
library(readr)
library(dplyr)
library(tidyr)
library(fuzzyjoin)
library(stringr)
alma <- read_excel("data/URI-ALMA-QA-04082019.xlsx", skip = 2)
names(alma) <- c("title", "lcclass", "pubdate", "publisher", "physitem", "lang")

maa <- read_excel("data/BLL_Feb_1_2018.xlsx", skip = 1)
names(maa) <- c("title",	"author",	"edition",	"publisher",	"pubyear",	"rating",	"topics")

```

Attempt to prevent memory error by filtering the datasetx to include only a single year.

```{r}

matchtitles <- function(x = maa, y = alma, yr=2019) {
  y <- y %>% 
  mutate(pubyear = parse_number(pubdate),
         title = str_replace(title, "[ ]*/$", "")) %>%
  filter(pubyear == yr)

  x <- x %>%
  filter(pubyear == yr)
  
  matches <- stringdist_join(x, y, 
                by = "title",
                mode = "left",
                ignore_case = TRUE, 
                method = "jw", 
                max_dist = 99, 
                distance_col = "dist") %>%
    select(title.x, title.y, dist, publisher.x, publisher.y, rating, topics) %>%
    arrange(title.x, dist) %>%
    group_by(title.x) %>%
    summarize(score = first(dist),
            title.y = first(title.y),
            publisher.x = first(publisher.x),
            publisher.y = first(publisher.y),
            rating = first(rating),
            topics = first(topics)) %>%
    arrange(desc(score)) %>%
    filter(score > .1)
  return(matches)  
}

# alma <- alma %>% 
#   mutate(pubyear = parse_number(pubdate)) %>%
#   filter(pubyear == 2008)
# 
# maa <- maa %>%
#   filter(pubyear == 2008)
```


Do a fuzzy join (generates error message -- Error: cannot allocate vector of size 1.0 Gb)
```{r}

df2008 <- matchtitles(maa, alma, 2008)
df2009 <- matchtitles(maa, alma, 2009)
df2010 <- matchtitles(maa, alma, 2010)
df2011 <- matchtitles(maa, alma, 2011)
df2012 <- matchtitles(maa, alma, 2012)
df2013 <- matchtitles(maa, alma, 2013)
df2014 <- matchtitles(maa, alma, 2014)
df2015 <- matchtitles(maa, alma, 2015)
df2016 <- matchtitles(maa, alma, 2016)
df2017 <- matchtitles(maa, alma, 2017)
df2018 <- matchtitles(maa, alma, 2018)
```

```{r}
review <- matches %>% 
  select(title.x, title.y, dist, publisher.x, publisher.y, rating, topics) %>%
  arrange(title.x, dist) %>%
  group_by(title.x) %>%
  summarize(score = first(dist),
            title.y = first(title.y),
            publisher.x = first(publisher.x),
            publisher.y = first(publisher.y),
            rating = first(rating),
            topics = first(topics)) %>%
  arrange(desc(score))
```

